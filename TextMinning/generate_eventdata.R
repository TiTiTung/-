# *******************************************************************
# ????????????: ?????????????????????, ?????????????????????
# *******************************************************************
# ????????????: 
#  1. event data 
#  2. stock historical close prices 
#  3. market index (close price)
# ????????????:
#  a list data 

# *******************************************************************
#  Packages
# *******************************************************************
library(eventstudies)
library(dplyr)
library(tidyr)

# *******************************************************************
# ????????????????????????
# *******************************************************************
# Input 1: event data (only two variables)
edat <- read.csv("edata1t.csv", colClasses=c("character","Date"))
names(edat) <- c("name","when")
# ???????????????event, ???????????????"X"
edat <- edat[!duplicated(edat),] %>%
  mutate(name=paste0("X",name))
# Input 2: all stock trading data, ???????????????"X"
sdat <- readRDS("Cstock.rds") %>%
  mutate(Stkcd=paste0("X",Stkcd))
# Input 3: market data (000001)
mdat <- readRDS("Mindex.rds")

# *******************************************************************
#  ??????????????????????????? (???????????????????????????)
# ******************************************************************* 
# ??????????????????
nowdate <- as.Date("2017-06-30")
# ??????????????????????????????
eventinerval <- 4000
useevent <- edat %>%
  filter(when<=nowdate, when>=nowdate-eventinerval)

# *******************************************************************
#  ??????stock data
# ******************************************************************* 
# ??????????????????????????????
sprice <- sdat %>%
  filter(Stkcd %in% useevent$name) %>%
  select(Trddt,Stkcd,Clsprc)

# ????????????????????????????????? => ??????phys2eventtime()?????????
sprice <- spread(sprice,Stkcd,Clsprc)
# ??????NA???, ???na????????????????????????NA???????????????
# ???????????????????????????????????????NA???
sprice <- na.locf(sprice)
# ?????????xts
sprice <- xts(sprice[,-1], as.Date(sprice$Trddt))

# *******************************************************************
#  ?????? market data
# ******************************************************************* 
mprice <- mdat %>%
  select(Trddt,Clsindex)

mprice <- xts(mprice[,-1], as.Date(mprice$Trddt))
names(mprice) <- "mindex"

sprice <- merge.xts(sprice,mprice,join="inner")
mevent <- useevent %>%
  mutate(name="mindex")

# *******************************************************************
#  
# ******************************************************************* 
# ??????????????? (???????????????)
esday=60
# ??????????????? (???????????????)
evday=120

es <- phys2eventtime(z = sprice, events = useevent, width = 20)
es.w <- window(es$z.e,start=-(esday+evday), end=evday)
# ???????????????event
useevent <- useevent[es$outcomes=="success",]
mevent <- mevent[es$outcomes=="success",]

# ?????????????????????????????? (????????????es.w??????)
mes <- phys2eventtime(z = sprice$mindex, events = mevent)
mes.w <- window(mes$z.e,start=-(esday+evday), end=evday)

#eventdata <- list(event=useevent, stock=es.w, market=mes.w, alldate=mdat$Trddt)



eventdata <- list(event=useevent, 
                  stock=es.w, 
                  market=mes.w, 
                  alldate=mdat$Trddt)

saveRDS(eventdata,"Event0002.rds")
